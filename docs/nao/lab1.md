---
title: Урок 1: Основы в Choregraphe
description: Изучение диалоговой системы QiChat для Nao
---
!!! note "Общий ключ для Choregraphe"
	Для регистрации Choregraphe используйте ключ (указан на странице [SoftBank](https://developer.softbankrobotics.com/us-en/downloads/nao-v5-v4))

	654e-4564-153c-6518-2f44-7562-206e-4c60-5f47-5f45

## Цель работы

Цель данной работы --- ознакомление с принципом работы с _Choregraphe_,
подключение робота к программе и изучение её базовых модулей.

## Теория

### Подключение Nao к Choregraphe

Перед выполнением работы следует подлючить робота к _Choregraphe_. Откройте
список доступных роботов. Для этого перейдите в меню `[Connection] > [Connect
to...]` или нажмите на панели инструментов кнопку ![connect to button](/images/btn/connect.png).
В появившемся окне подключитесь к нужному роботу. Если в списке отсутствует
требуемый робот (такое может случиться, если в системе не установлена служба
_Apple Bonjour_), то просто укажите справа нужный IP-адрес и порт (по умолчанию ---
`9559`, его можно не менять). Чтобы узнать IP робота, нажмите на его _Chest
Button_.

### Блоки и первая фраза

В _Choregaphe_ основной элемент визуального программирования --- _блок_. У
каждого блока есть один или несколько входов (слева) и выходов (справа). Входы
управляют запуском и остановкой блока, а выходы позволяют возвращать результат
работы блока. Верхний вход ![onstart button io](/images/btn-io/onstart.png)
запускает работу блока по сигналу, нижний вход ![onstop button io](/images/btn-io/onstop.png)
--- прерывает по сигналу. Выход ![onstopped button io](/images/btn-io/onstopped.png)
отправляет сигнал после того, как полностью завершилось действие, записанное в
блоке. Если выходов у блока больше одного, то верхний будет задействован при
успешном окончании действия, а нижний --- при прерывании из-за ошибки. Для
каждого конкретного блока описание тех или иных элементов можно посмотреть, если
навести мышку на соответсвующую иконку и задержать на несколько секунд. Сам
сигнал отображается зеленым кружком на соединительных линиях, по которым
проходит. Также у многих блоков имеются параметры, список которых можно вызвать,
кликнув по иконке гаечного ключа ![wrench button io](/images/btn-io/wrench.png).

Рассмотрим простейший пример: научим робота произносить первую фразу. Для этого
нам понадобится блок `Say`, который расположен на вкладке _standard_ (панель
_Box libraries_) в папке `[Audio] > [Voice]`. Просто перетяните блок `Say` на
рабочее пространство (центральная часть программы). Если панели _Box libraries_
нигде нет, то откройте её из меню `[View] > [Box libraries]`.

При этом стоит учитывать, что, хотя робот поддерживает множество языков,
самостоятельно под введённый текст он не подстраивается. Чтобы избежать ошибок в
произношении, очень желательно добавлять перед каждым блоком `Say` блок `Set
Language`, который находится в библиотеке блоков в папке `[Audio] > [Voice]`. Он
позволяет настроить язык, который будет использоваться в `Say`, для этого нужно
выбрать его в _параметрах_ ![wrench button io](/images/btn-io/wrench.png)
блока. Также стоит проверить, правильный ли язык выставлен внутри самого блока
`Say`: кликните по нему дважды, чтобы открыть, и удостоверьтесь, что в блоке
`Localized text` выбран английский.

![sayinside screenshot](/images/screenshots/lab1-sayinside.png)

Всего на роботе доступно два языка одновременно (возможно, в дальнейшем
`Aldebaran Robotics` научатся загружать больше пакетов на робота, но на данный
момент это не случилось), и, если ничего странного вроде переустановки с
роботами не произошло, то в данном случае это английский и русский. Как и многие
другие модули, которые влияют на настройки робота, модуль `Set Language`
изменяет настройки робота перманентно, это значит, что после завершения
программы язык не изменится обратно. Поэтому желательно добавить перед выходом
из программы еще один блок `Set Language` в котором язык снова изменится на
английский. Кроме организационных моментов, это поможет в дальнейшем, когда мы
начнем распознавание голоса --- встроенная библиотека лучше работает с
английской речью, чем с русской.

![langselect screenshot](/images/screenshots/lab1-langselect.png)

Для запуска примера соедините начало программы ![onstart button io](/images/btn-io/onstart.png)
со входом блока ![onstart button io](/images/btn-io/onstart.png), а затем выход
блока ![onstopped button io](/images/btn-io/onstopped.png) с выходом программы
![onstopped button io](/images/btn-io/onstopped.png). Чтобы запустить программу,
выберите в меню `[Connection] > [Upload to robot and Play]` или нажмите на
соответствующую кнопку на панели наверху ![play button](/images/btn/play.png)
или ++f5++ на клавиатуре.


!!! tip "Подсказка"
	Чем больше схема, тем сложнее ее читать, а значит и искать в ней ошибки.
	Рекомендуется создать новый составной блок (подобно блоку `Say`): в
	контекстном меню (правая кнопка мыши) в центральной области выберите
	`[Create a new box] > [Diagram...]`, дайте ему любое имя и нажмите `[OK]`.
	Переместите блоки выбора языка и речи внутрь нового блока (при помощи
	обычных команд ++ctrl+x++, ++ctrl+v++).

Убедитесь, что после создания нового блока функциональность не изменилась, и переходите к следующему заданию.


### Параллельные действия и первые движения

В _Choregraphe_ каждый выход можно подключить сразу к нескольким входам, в таком
случае начнется параллельное выполнение нескольких действий. Очевидно, что
действия не длятся равное количество времени, например, робот может произнести
фразу в разы быстрее, чем пройти значительное расстояние по земле. В некоторых
случаях требуется синхронизация сигналов и для этого используется модуль `Wait
For Signals`. Данный модуль находится в директории _Flow Control_.

Расположите на рабочей области модули `Wait For Signals` и блок с простейшей
анимацией `Hello` (`[Motions] > [Animations]`), а затем соедините так, как
показано на рисунке ниже.

![parallel screenshot](/images/screenshots/lab1-parallel.png)

В данном примере программа одновременно и параллельно запускает анимацию
приветствия и произнесения `hello`, а поскольку работа блока речи завершается
быстрее, программа ждет конца анимации, и только после завершения обоих
процессов от блока `Wait For Signal` идет сигнал к выходу из программы.
Проверьте это на роботе.

Стоит отметить важный момент при анимировании робота, а именно жёсткую фиксацию
его соединений --- `Stiffness`. Включение жёсткой фиксации в _Choregraphe_
подаёт питание к моторам Nao. Когда робот не зафиксирован, его конечности
расслаблены, как у марионетки, и к моторам питание не подведено. Чтобы робот мог
самостоятельно выполнять движения, включённые в программу, требуется его
зафиксировать. В _Choregraphe_ это можно сделать несколькими способами:

* кнопками на верхней панели `[Wake up]` ![motors on button](/images/btn/motors_on.png)
	--- для включения фиксации и `[Rest]` ![motors off button](/images/btn/motors_off.png)
	--- для отключения;
* блоками `Motor On/Off`, `SetStiffness`, `Rest` и `WakeUp`, где последние два
	полностью дублируют соответствующие кнопки меню, первый фактически тоже, разве
	что команды задаются переключателем `On/Off` в параметрах блока, а
	`SetStiffness` позволяет отдельно назначить степень и длительность отключения
	или включения мотора и конкретный сустав робота, который требуется
	включить/отключить.

Как и в конце предыдущего пункта, рекомендуется собрать результаты в отдельный
блок, он понадобится в следующем задании.

### События и сенсоры

!!! bug "Сенсоры"
	Роботы довольно старые, а прошивку NaoQi давно не обновляли, после того, как
	компанию Aldebaran купила японская компания SoftBank.
	Некоторые сенсоры могут не работать.

	¯\\\_(ツ)\_/¯

В этом задании мы создадим простейший диалог, который позволит вводить голосовые
команды и осуществлять различные действия в зависимости от команды, помимо этого
научимся использовать в программе тактильные сенсоры.

Начнем с простого, с сенсоров. С левой стороны рабочего поля, под иконкой
начального сигнала ![onstart button io](/images/btn-io/onstart.png), находится
кнопка для добавления входов с сенсоров ![add io button io](/images/btn-io/add-io.png).
Если на нее нажать, то всплывет окно, в котором можно указать, события каких
сенсоров нам требуются. Найдём для примера параметр _MiddleTactileTouched_
(удобнее воспользоваться поиском): после его добавления должна появиться новая
иконка ![stm button io](/images/btn-io/stm.png). Сигнал от нее пойдет, если в
то время, пока программа запущена, прикоснуться к центральному тактильному
сенсору на голове робота. Это легко проверить, достаточно удалить сигнал(ы) от
входной точки программы ![onstart button io](/images/btn-io/onstart.png) и
подключить только событие ![stm button io](/images/btn-io/stm.png).

Сразу после запуска программы ничего не произойдет, и приветствие сработает
после прикосновения к голове робота.

## Задания

Создайте две программы в _Choregraphe_ в соответствии с заданием:

**Задание 1**
:	Робот должен пройтись прямо и одновременно произнести какую-нибудь фразу,а
	после выполнения обоих действий назвать температуру в голове и сесть.

**Задание 2**
:	Робот должен произносить `left hand` или `right hand` в зависимости от того,
	за какую руку его трогают.
